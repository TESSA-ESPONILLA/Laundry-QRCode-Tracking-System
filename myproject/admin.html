<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaundryTrack - Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
 <!-- <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDT4kkrrr_b1oThap6A_Y1Ry0ub4aBDjt0",
            authDomain: "laundry-tracking-system.firebaseapp.com",
            projectId: "laundry-tracking-system",
            storageBucket: "laundry-tracking-system.appspot.com",
            messagingSenderId: "641186465385",
            appId: "1:641186465385:web:c04028a8400ff48eb984f8",
            measurementId: "G-VLXNQRRGJK"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Make db available globally
        window.db = db;
        window.getDocs = getDocs;
        window.collection = collection;
        window.addDoc = addDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
    </script>

    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
        }

        /* Add these to your existing styles */


        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .btn-gradient {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            color: white;
        }

        .admin-nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .qr-code-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            display: inline-block;
        }

        .page-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-received {
            background-color: var(--info-color);
            color: white;
        }

        .status-processing {
            background-color: var(--warning-color);
            color: white;
        }

        .status-completed {
            background-color: var(--success-color);
            color: white;
        }

        .notification-status {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .delivery-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .delivered { background-color: var(--success-color); }
        .pending { background-color: var(--warning-color); }
        .failed { background-color: var(--danger-color); }

        .admin-table {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
        }

        .admin-table th {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 15px;
        }

        .admin-table td {
            color: white;
            border: none;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .notification-modal .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
        }

        .btn-send {
            background: linear-gradient(45deg, var(--success-color), var(--info-color));
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
        }

        .btn-send:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .text-muted {
            color: white;
        }

        #barcodeCanvas {
    max-width: 100%;
    height: auto;
}

.receipt-container {
    background-color: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    max-width: 800px;
    margin: 0 auto;
}

.receipt-header {
    border-bottom: 2px solid #eee;
    padding-bottom: 20px;
    margin-bottom: 20px;
}

.receipt-header h3 {
    color: #333;
    font-size: 24px;
    margin-bottom: 5px;
}

.receipt-details {
    color: #444;
}

.receipt-details p {
    margin-bottom: 8px;
    font-size: 16px;
}

.receipt-items {
    margin: 20px 0;
}

.receipt-items table {
    width: 100%;
    border-collapse: collapse;
}

.receipt-items th {
    background-color: #f8f9fa;
    padding: 12px;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
}

.receipt-items td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
}

.receipt-footer {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #eee;
    color: #666;
}

.receipt-footer .small {
    font-size: 14px;
    color: #999;
}

@media print {
    .receipt-container {
        box-shadow: none;
    }
    
    .modal-footer,
    .btn-close {
        display: none !important;
    }
}
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg admin-nav">
        <div class="container">
            <a class="navbar-brand text-white fw-bold" href="index.html">
                <i class="fas fa-tshirt me-2"></i>LaundryTrack
            </a>
            <div class="navbar-nav ms-auto">
                <a href="index.html" class="btn btn-outline-light me-2">
                    <i class="fas fa-users me-1"></i>Customer View
                </a>
                <button class="btn btn-gradient">
                    <i class="fas fa-cog me-1"></i>Admin Panel
                </button>
            </div>
        </div>
    </nav>

    <!-- Admin Panel -->
    <div class="container py-4">
        <div class="page-header text-center text-white">
            <h1 class="display-4 fw-bold mb-3">Admin Dashboard</h1>
            <p class="lead">Manage laundry transactions and update status</p>
        </div>

        <!-- Admin Navigation -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-3">
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-gradient active" onclick="showAdminSection('newTransaction', event)">
                           <i class="fas fa-plus me-2"></i>New Transaction
                       </button>
                       <button class="btn btn-outline-light" onclick="showAdminSection('manageOrders', event)">
                           <i class="fas fa-list me-2"></i>Manage Orders
                       </button>
                       <button class="btn btn-outline-light" onclick="showAdminSection('generateQR', event)">
                           <i class="fas fa-barcode me-2"></i>Generate Barcode
                       </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Transaction Section -->
        <div id="newTransaction" class="admin-section">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="glass-card p-4">
                        <h4 class="text-white mb-4">
                            <i class="fas fa-plus-circle me-2"></i>Create New Laundry Transaction
                        </h4>
                        <form id="newTransactionForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-white">Customer Name</label>
                                    <input type="text" class="form-control form-control-lg" id="customerName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-white">Phone Number</label>
                                    <input type="tel" class="form-control form-control-lg" id="phoneNumber" required>
                                </div>
                                <div class="col-md-12 mb-3"> <label class="form-label text-white">Email</label>
                                    <input type="email" class="form-control form-control-lg" id="email" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-white">Service Type</label>
                                    <select class="form-select form-select-lg" id="serviceType" required>
                                        <option value="">Select Service</option>
                                        <option value="wash-only">Wash Only</option>
                                        <option value="wash-dry">Wash & Dry</option>
                                        <option value="dry-clean">Dry Clean</option>
                                        <option value="iron-only">Iron Only</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-white">Weight (kg)</label>
                                    <input type="number" class="form-control form-control-lg" id="weight" step="0.1" min="0.1" max="50" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-white">Estimated Pickup Date</label>
                                    <input type="date" class="form-control form-control-lg" id="pickupDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-white">Estimated Pickup Time</label>
                                    <input type="time" class="form-control form-control-lg" id="pickupTime" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-white">Special Instructions</label>
                                <textarea class="form-control" id="instructions" rows="3" placeholder="Any special care instructions..."></textarea>
                            </div>
                            <button type="button" class="btn btn-gradient btn-lg w-100" onclick="saveTransaction()">
                                <i class="fas fa-save me-2"></i>Save Transaction
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manage Orders Section -->
        <div id="manageOrders" class="admin-section" style="display: none;">
            <div class="glass-card p-4">
                <h4 class="text-white mb-4">
                    <i class="fas fa-list me-2"></i>Manage Laundry Orders
                </h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Tracking Code</th>
                                <th>Customer</th>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Pickup Time</th>
                                <th>Notifications</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loadOrdersTable">
                            <!-- Orders will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


     <!-- Notification Modal -->
   <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content notification-modal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-bell me-2"></i>Send Notification
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Customer</label>
                        <input type="text" class="form-control" id="modalCustomerName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tracking Code</label>
                        <input type="text" class="form-control" id="modalTrackingCode" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message Type</label>
                        <select class="form-select" id="messageType">
                            <option value="ready">Ready for Pickup</option>
                            <option value="completed">Order Completed</option>
                            <option value="delayed">Delay Notification</option>
                            <option value="custom">Custom Message</option>
                        </select>
                    </div>
                    <div class="mb-3" id="customMessageDiv" style="display: none;">
                        <label class="form-label">Custom Message</label>
                        <textarea class="form-control" id="customMessage" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendEmail" checked>
                            <label class="form-check-label" for="sendEmail">Send Email</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendSMS" checked>
                            <label class="form-check-label" for="sendSMS">Send SMS</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-gradient" onclick="sendNotification()">
                        <i class="fas fa-paper-plane me-2"></i>Send Notification
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Replace the Generate QR Section with this Barcode Scanner Section -->
<div id="generateQR" class="admin-section" style="display: none;">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="glass-card p-4 text-center">
                <h4 class="text-white mb-4">
                    <i class="fas fa-barcode me-2"></i>Barcode Scanner
                </h4>
                <div class="mb-3">
                    <label class="form-label text-white">Enter Tracking Code</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="trackingInput" placeholder="Enter tracking code (e.g., LT-ABC123)">
                        <button class="btn btn-gradient" onclick="generateBarcode(document.getElementById('trackingInput').value)">
                            <i class="fas fa-barcode me-2"></i>Generate Barcode
                        </button>
                        </div>
                         <div id="barcodeDisplay" class="mt-3 text-center" style="display: none;">
                                <canvas id="barcodeCanvas"></canvas>
                                <p class="text-white mt-2">Tracking Code: <span id="trackingText"></span></p>
                                <button class="btn btn-light mt-2" onclick="printBarcode()">
                                    <i class="fas fa-print me-2"></i>Print Barcode
                                </button>
                                <button class="btn btn-light mt-2 ms-2" onclick="downloadBarcode()">
    <i class="fas fa-download me-2"></i>Download
</button>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" >
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaction Receipt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="receiptContent">
                <div class="receipt-container">
                    <div class="receipt-header text-center">
                        <h3>Flip N Fold Laundry</h3>
                        <p>Official Receipt</p>
                        <hr>
                    </div>
                    <div class="receipt-details">
                        <p><strong>Tracking Code:</strong> <span id="receipt-tracking"></span></p>
                        <p><strong>Date:</strong> <span id="receipt-date"></span></p>
                        <p><strong>Customer:</strong> <span id="receipt-customer"></span></p>
                        <div class="receipt-items">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Weight</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="receipt-items">
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                                        <td id="receipt-subtotal"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Tax (12%):</strong></td>
                                        <td id="receipt-tax"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                        <td id="receipt-total"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="receipt-footer text-center mt-4">
                            <p>Thank you for choosing Flip N Fold!</p>
                            <p class="small">Keep this receipt for pickup reference</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printReceipt()">
                    <i class="fas fa-print me-2"></i>Print Receipt
                </button>
            </div>
        </div>
    </div>
</div>



    <div id="emailConfirmationFrame" style="display: none;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        let laundryData = {};

        async function loadData() {
            try {
                const querySnapshot = await getDocs(collection(db, "laundryOrders"));
                laundryData = {};
                querySnapshot.forEach((doc) => {
                    laundryData[doc.id] = { id: doc.id, ...doc.data() };
                });
                loadOrdersTable();
            } catch (error) {
                console.error("Error loading data from Firebase:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load orders data',
                    confirmButtonText: 'OK'
                });
            }
        }

        function validateForm() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            if (!/^[\d\s\+\-\(\)]{8,15}$/.test(phoneNumber)) {
                throw new Error('Please enter a valid phone number');
            }
            
            const weight = parseFloat(document.getElementById('weight').value);
            if (weight <= 0 || weight > 50) {
                throw new Error('Weight must be between 0.1 and 50 kg');
            }
            
            const pickupDate = new Date(document.getElementById('pickupDate').value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (pickupDate < today) {
                throw new Error('Pickup date must be today or in the future');
            }
        }

        function generateTrackingCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = 'LT-';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function saveTransaction() {
            try {
                // Get form values
                const customerName = document.getElementById('customerName').value.trim();
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                 const email = document.getElementById('email').value.trim();
                const serviceType = document.getElementById('serviceType').value;
                const weight = parseFloat(document.getElementById('weight').value);
                const pickupDate = document.getElementById('pickupDate').value;
                const pickupTime = document.getElementById('pickupTime').value;
                const instructions = document.getElementById('instructions').value.trim();

                // Validate required fields
                if (!customerName || !phoneNumber || !serviceType || isNaN(weight) || !pickupDate || !pickupTime) {
                    throw new Error('Please fill in all required fields correctly.');
                }

                // Additional validation
                validateForm();

                // Generate tracking code
                const trackingCode = generateTrackingCode();

                // Create transaction object with proper timestamps structure
                const transaction = {
                    trackingCode,
                    customerName,
                    phoneNumber,
                    email,
                    serviceType,
                    weight,
                    pickupDate,
                    pickupTime,
                    instructions,
                    status: 'received',
                    createdAt: new Date().toISOString(),
                    timestamps: {
                        received: new Date().toLocaleString()
                    }
                };

                // Save to Firebase
                const docRef = await addDoc(collection(db, "laundryOrders"), transaction);
                console.log("Transaction saved with ID: ", docRef.id);

                // Update local data
                laundryData[docRef.id] = { id: docRef.id, ...transaction };

                // Show success message
                await Swal.fire({
                    icon: 'success',
                    title: 'Transaction Saved!',
                    html: `Tracking Code: <strong>${trackingCode}</strong>`,
                    confirmButtonText: 'OK'
                });

                showReceipt(docRef.id);

                // Reset form
                document.getElementById('newTransactionForm').reset();
                
                // Set default pickup date to tomorrow again
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('pickupDate').valueAsDate = tomorrow;


                // Refresh orders table
                await loadData();

            } catch (error) {
                console.error("Error saving transaction:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to save transaction',
                    confirmButtonText: 'OK'
                });
            }
        }



        // Function to show receipt
function showReceipt(orderId) {
    const order = laundryData[orderId];
    if (!order) return;

    // Calculate rates based on service type
    const rates = {
        'wash-only': 35,
        'wash-dry': 50,
        'dry-clean': 75,
        'iron-only': 25
    };

    const rate = rates[order.serviceType] || 35;
    const amount = rate * order.weight;
    const tax = amount * 0.12;
    const total = amount + tax;

    // Update receipt content
    document.getElementById('receipt-tracking').textContent = order.trackingCode;
    document.getElementById('receipt-date').textContent = new Date().toLocaleDateString();
    document.getElementById('receipt-customer').textContent = order.customerName;

    // Update receipt items
    const itemsTable = document.getElementById('receipt-items');
    itemsTable.innerHTML = `
        <tr>
            <td>${getServiceTypeName(order.serviceType)}</td>
            <td>${order.weight} kg</td>
            <td>₱${rate.toFixed(2)}/kg</td>
            <td>₱${amount.toFixed(2)}</td>
        </tr>
    `;

    // Update totals
    document.getElementById('receipt-subtotal').textContent = `₱${amount.toFixed(2)}`;
    document.getElementById('receipt-tax').textContent = `₱${tax.toFixed(2)}`;
    document.getElementById('receipt-total').textContent = `₱${total.toFixed(2)}`;

    // Show modal
    const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
    receiptModal.show();
}

// Function to print receipt
function printReceipt() {
    const receiptContent = document.getElementById('receiptContent').innerHTML;
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Laundry Receipt</title>
            <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { padding: 20px; }
                @media print {
                    .modal-footer { display: none; }
                }
            </style>
        </head>
        <body>
            ${receiptContent}
            <script>
                window.onload = function() {
                    window.print();
                    window.onafterprint = function() {
                        window.close();
                    }
                }
            <\/script>
        </body>
        </html>
    `);
    
    printWindow.document.close();
}

        function showAdminSection(sectionId, event) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';

            // Update button states
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active', 'btn-gradient');
                btn.classList.add('btn-outline-light');
            });

            if (event) {
                event.target.classList.add('active', 'btn-gradient');
                event.target.classList.remove('btn-outline-light');
            }

            // Load data if needed
            if (sectionId === 'manageOrders') {
                loadOrdersTable();
            }
        }



function updateOrderStatus(orderId) {
    const order = laundryData[orderId];
    if (!order) return;
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('orderLookupModal'));
    
    Swal.fire({
        title: 'Update Order Status',
        input: 'select',
        inputOptions: {
            'received': 'Received',
            'processing': 'Processing',
            'completed': 'Completed'
        },
        inputValue: order.status || 'received',
        showCancelButton: true,
        confirmButtonText: 'Update',
        preConfirm: (status) => {
            return updateOrderStatusInFirebase(orderId, status);
        }
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                icon: 'success',
                title: 'Status Updated',
                text: `Order status updated to ${result.value}`,
                confirmButtonText: 'OK'
            });
            
            if (modal) {
                modal.hide();
            }
        }
    });
}

async function updateOrderStatusInFirebase(orderId, status) {
    try {
        const orderRef = doc(db, "laundryOrders", orderId);
        await updateDoc(orderRef, {
            status: status,
            timestamps: {
                ...laundryData[orderId].timestamps,
                [status]: new Date().toLocaleString()
            }
        });
        
        // Update local data
        laundryData[orderId].status = status;
        laundryData[orderId].timestamps[status] = new Date().toLocaleString();
        
        return status;
    } catch (error) {
        console.error('Error updating status:', error);
        throw new Error('Failed to update status');
    }
}

// Initialize the scanner when the page loads
document.addEventListener('DOMContentLoaded', () => {
    initializeScanner();
    
    // Load Tesseract.js when text recognition is selected
    document.getElementById('scanType').addEventListener('change', function() {
        if (this.value === 'text' && !window.Tesseract) {
            // Load Tesseract.js dynamically
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js';
            document.head.appendChild(script);
        }
    });
});



// Function to generate a barcode from the tracking code
function generateBarcode(trackingCode) {
    if (!trackingCode) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Please enter a valid tracking code',
            confirmButtonText: 'OK'
        });
        return;
    }

    try {
        const canvas = document.getElementById('barcodeCanvas');
        const container = document.getElementById('barcodeDisplay');
        
        // Clear previous barcode
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Use JsBarcode to generate the barcode
        JsBarcode(canvas, trackingCode, {
            format: "CODE128", // Most versatile barcode format
            width: 2,
            height: 100,
            displayValue: true,
            fontSize: 16,
            margin: 10,
            background: "#ffffff",
            lineColor: "#000000"
        });

        // Update the display
        document.getElementById('trackingText').textContent = trackingCode;
        container.style.display = 'block';

    } catch (error) {
        console.error('Barcode generation error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Barcode Generation Failed',
            text: 'There was an error generating the barcode. Please try again.',
            confirmButtonText: 'OK'
        });
    }
}

// Function to print the barcode
function printBarcode() {
    const canvas = document.getElementById('barcodeCanvas');
    const trackingCode = document.getElementById('trackingText').textContent;
    
    if (!canvas || !trackingCode) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No barcode to print',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Barcode - ${trackingCode}</title>
            <style>
                body { text-align: center; padding: 20px; font-family: Arial, sans-serif; }
                h3 { margin-bottom: 10px; }
                img { margin: 10px auto; display: block; }
                @media print {
                    body { padding: 0; }
                }
            </style>
        </head>
        <body>
            <h3>LaundryTrack Barcode</h3>
            <p>Tracking: ${trackingCode}</p>
            <img src="${canvas.toDataURL('image/png')}" alt="Barcode">
            <script>
                window.onload = function() {
                    setTimeout(function() {
                        window.print();
                        window.close();
                    }, 200);
                }
            <\/script>
            <p>Thank you for Trusting our service!</p>
        </body>
        </html>`);
    
    printWindow.document.close();
}

// Function to download the barcode
function downloadBarcode() {
    const canvas = document.getElementById('barcodeCanvas');
    const trackingCode = document.getElementById('trackingText').textContent;
    
    if (!canvas || !trackingCode) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No barcode to download',
            confirmButtonText: 'OK'
        });
        return;
    }
    
    const link = document.createElement('a');
    link.download = `LaundryTrack-Barcode-${trackingCode}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
}

// Add this to your initialization code
document.addEventListener('DOMContentLoaded', function() {
    // Set up canvas dimensions
    const canvas = document.getElementById('barcodeCanvas');
    canvas.width = 300;
    canvas.height = 150;
    
   
});
        

        function getServiceTypeName(serviceType) {
            const serviceMap = {
                'wash-only': 'Wash Only',
                'wash-dry': 'Wash & Dry',
                'dry-clean': 'Dry Clean',
                'iron-only': 'Iron Only'
            };
            return serviceMap[serviceType] || serviceType;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('pickupDate').valueAsDate = tomorrow;
            
            loadData();
        });

        document.getElementById('newTransactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveTransaction();
        });

        const EMAILJS_SERVICE_ID = 'service_flipnfold';
        const EMAILJS_TEMPLATE_ID = 'templete_flipnfold';

  function showNotificationModal(orderId) {
        const order = laundryData[orderId];
        if (order) {
            document.getElementById('modalCustomerName').value = order.customerName;
            document.getElementById('modalTrackingCode').value = order.trackingCode;
            document.getElementById('modalCustomerEmail').value = order.email;
            
            document.getElementById('messageType').value = 'ready';
            document.getElementById('customMessageDiv').style.display = 'none';
            document.getElementById('customMessage').value = '';
            document.getElementById('sendEmail').checked = true;

            document.querySelector('#notificationModal .btn-gradient').setAttribute('data-order-id', orderId);

            const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
            notificationModal.show();
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Order not found for notification.',
                confirmButtonText: 'OK'
            });
        }
    }

    async function sendNotification() {
        const orderId = document.querySelector('#notificationModal .btn-gradient').getAttribute('data-order-id');
        const order = laundryData[orderId];

        if (!order) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Order not found for sending notification.',
                confirmButtonText: 'OK'
            });
            return;
        }

        const messageType = document.getElementById('messageType').value;
        let messageContent = '';
        let emailSubject = '';

        switch (messageType) {
            case 'ready':
                messageContent = `Your laundry order (Tracking: ${order.trackingCode}) is ready for pickup!`;
                emailSubject = `Your Laundry Order ${order.trackingCode} is Ready!`;
                break;
            case 'completed':
                messageContent = `Your laundry order (Tracking: ${order.trackingCode}) has been completed. Thank you for choosing Flip N Fold!`;
                emailSubject = `Your Laundry Order ${order.trackingCode} is Complete!`;
                break;
            case 'delayed':
                messageContent = `Attention: Your laundry order (Tracking: ${order.trackingCode}) is experiencing a slight delay. We will notify you when it's ready. We apologize for the inconvenience.`;
                emailSubject = `Important Update: Your Laundry Order ${order.trackingCode} is Delayed`;
                break;
            case 'custom':
                messageContent = document.getElementById('customMessage').value.trim();
                emailSubject = `Update Regarding Your Flip N Fold Order ${order.trackingCode}`; // Default custom subject
                if (!messageContent) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Warning',
                        text: 'Please enter a custom message.',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                break;
        }

        const sendEmail = document.getElementById('sendEmail').checked;

        if (!sendEmail) {
            Swal.fire({
                icon: 'warning',
                title: 'Warning',
                text: 'Please select at least one notification method (Email).',
                confirmButtonText: 'OK'
            });
            return;
        }

        Swal.fire({
            title: 'Sending Notification...',
            text: 'Please wait, this may take a moment.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        try {
            const templateParams = {
                to_name: order.customerName,
                customer_email: order.email,
                tracking_code: order.trackingCode,
                message: messageContent,
                subject: emailSubject,
            };

            if (sendEmail) {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                    .then(function(response) {
                       console.log('Email successfully sent!', response.status, response.text);
                    }, function(error) {
                       console.error('Failed to send email:', error);
                       throw new Error('Email sending failed.');
                    });
            }

            const notificationRecord = {
                message: messageContent,
                timestamp: new Date().toLocaleString(),
                type: messageType,
                methods: {
                    email: sendEmail,
                    sms: false
                },
                status: 'sent'
            };

            const orderRef = doc(db, "laundryOrders", orderId);
            let currentNotifications = order.notifications || [];
            currentNotifications.push(notificationRecord);

            await updateDoc(orderRef, {
                notifications: currentNotifications
            });

            laundryData[orderId].notifications = currentNotifications;
            loadOrdersTable();

            Swal.fire({
                icon: 'success',
                title: 'Notification Sent!',
                text: 'The email notification has been sent successfully.',
                confirmButtonText: 'OK'
            });

            const notificationModal = bootstrap.Modal.getInstance(document.getElementById('notificationModal'));
            if (notificationModal) {
                notificationModal.hide();
            }
        } catch (error) {
            console.error("Error sending notification:", error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Failed to send notification. ${error.message || ''} Please try again.`,
                confirmButtonText: 'OK'
            });
        }
    }

    function loadOrdersTable() {
        const tbody = document.getElementById('loadOrdersTable');
        tbody.innerHTML = ''; 

        const sortedOrders = Object.values(laundryData).sort((a, b) => 
            new Date(b.createdAt) - new Date(a.createdAt)
        );

        sortedOrders.forEach(order => {
            const tr = document.createElement('tr');
            const statusClass = `status-${order.status || 'received'}`;
            const statusText = (order.status || 'received').charAt(0).toUpperCase() + (order.status || 'received').slice(1);
            
            let notificationStatusHtml = '';
            if (order.notifications && order.notifications.length > 0) {
                const lastNotification = order.notifications[order.notifications.length - 1];
                let indicatorClass = 'pending';
                if (lastNotification.status === 'sent') {
                    indicatorClass = 'delivered';
                } else if (lastNotification.status === 'failed') {
                    indicatorClass = 'failed';
                }
                notificationStatusHtml = `
                    <span class="delivery-indicator ${indicatorClass}"></span>
                    <span class="notification-status text-muted">${lastNotification.type || 'Sent'} on ${new Date(lastNotification.timestamp).toLocaleDateString()}
                    </span>
                `;
            } else {
                notificationStatusHtml = `<span class="text-muted">No notification sent</span>`; // More descriptive message
            }

            tr.innerHTML = `
                <td><strong>${order.trackingCode}</strong></td>
                <td>${order.customerName}<br><small class="text-muted">${order.phoneNumber}</small><br><small class="text-info">${order.email || 'No Email'}</small></td>
                <td>${getServiceTypeName(order.serviceType)}<br><small class="text-muted">${order.weight}kg</small></td>
               <td>
    <select class="form-select form-select-sm status-select" data-id="${order.id}">
         <option value="received" ${order.status === 'received' ? 'selected' : ''}>Received</option>
            <option value="washing" ${order.status === 'washing' ? 'selected' : ''}>Washing</option>
            <option value="drying" ${order.status === 'drying' ? 'selected' : ''}>Drying</option>
            <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready for Pickup</option>
            <option value="picked-up" ${order.status === 'picked-up' ? 'selected' : ''}>Picked Up</option>
    </select>
</td>
                <td>${formatDate(order.pickupDate)}<br><small class="text-muted">${order.pickupTime}</small></td>
                <td>
                    <button class="btn btn-sm btn-send send-notification-btn" data-id="${order.id}" 
                            data-bs-toggle="modal" data-bs-target="#notificationModal">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                    ${notificationStatusHtml}
                </td>
                <td>
                    ${order.status !== 'completed' ? 
                        `<button class="btn btn-sm btn-success mark-done me-1" data-id="${order.id}">
                            <i class="fas fa-check"></i> Complete
                        </button>` : 
                        '<span class="text-success"><i class="fas fa-check-circle"></i> Done</span>'
                    }
                    <button class="btn btn-sm btn-danger delete-order" data-id="${order.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.querySelectorAll('.mark-done').forEach(button => {
            button.addEventListener('click', async function() {
                const orderId = this.getAttribute('data-id');
                const order = laundryData[orderId];
                
                try {
                    const orderRef = doc(db, "laundryOrders", orderId);
                    await updateDoc(orderRef, {
                        status: 'completed',
                        timestamps: {
                            ...order.timestamps,
                            completed: new Date().toLocaleString()
                        }
                    });
                    
                    laundryData[orderId].status = 'completed';
                    laundryData[orderId].timestamps.completed = new Date().toLocaleString();
                    
                    loadOrdersTable();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Order Completed',
                        text: `Order ${order.trackingCode} has been marked as completed`,
                        confirmButtonText: 'OK',
                        timer: 2000
                    });
                } catch (error) {
                    console.error("Error updating order:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to update order status',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });

        document.querySelectorAll('.delete-order').forEach(button => {
            button.addEventListener('click', async function() {
                const orderId = this.getAttribute('data-id');
                
                const result = await Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                });

                if (result.isConfirmed) {
                    try {
                        await deleteDoc(doc(db, "laundryOrders", orderId));
                        delete laundryData[orderId];
                        loadOrdersTable();
                        Swal.fire(
                            'Deleted!',
                            'The order has been deleted.',
                            'success'
                        );
                    } catch (error) {
                        console.error("Error deleting order:", error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to delete order',
                            confirmButtonText: 'OK'
                        });
                    }
                }
            });
        });

        document.querySelectorAll('.send-notification-btn').forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-id');
                showNotificationModal(orderId);
            });
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadData();
        
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('pickupDate').valueAsDate = tomorrow;

        document.getElementById('messageType').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('customMessageDiv').style.display = 'block';
            } else {
                document.getElementById('customMessageDiv').style.display = 'none';
            }
        });

        document.querySelector('#notificationModal .btn-gradient').addEventListener('click', sendNotification);
    });
document.querySelectorAll('.status-select').forEach(select => {
    select.addEventListener('change', async function() {
        const orderId = this.getAttribute('data-id');
        const newStatus = this.value;
        const order = laundryData[orderId];
        try {
            const orderRef = doc(db, "laundryOrders", orderId);
            await updateDoc(orderRef, {
                status: newStatus,
                timestamps: {
                    ...order.timestamps,
                    [newStatus]: new Date().toLocaleString()
                }
            });
            laundryData[orderId].status = newStatus;
            laundryData[orderId].timestamps[newStatus] = new Date().toLocaleString();
            loadOrdersTable();
            Swal.fire({
                icon: 'success',
                title: 'Status Updated',
                text: `Order ${order.trackingCode} status updated to ${newStatus}`,
                confirmButtonText: 'OK',
                timer: 2000
            });
        } catch (error) {
            console.error("Error updating status:", error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to update order status',
                confirmButtonText: 'OK'
            });
        }
    });
});


    
    </script>
</body>
</html>
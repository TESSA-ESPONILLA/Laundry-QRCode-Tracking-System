<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaundryTrack - Admin Panel</title>

    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/admin-ds.css">

    <link href='https://fonts.googleapis.com/css?family=Shrikhand' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";


        const firebaseConfig = {
            apiKey: "AIzaSyDT4kkrrr_b1oThap6A_Y1Ry0ub4aBDjt0",
            authDomain: "laundry-tracking-system.firebaseapp.com",
            projectId: "laundry-tracking-system",
            storageBucket: "laundry-tracking-system.appspot.com",
            messagingSenderId: "641186465385",
            appId: "1:641186465385:web:c04028a8400ff48eb984f8",
            measurementId: "G-VLXNQRRGJK"
        };


        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);


        window.db = db;
        window.getDocs = getDocs;
        window.collection = collection;
        window.addDoc = addDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
    </script>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg admin-nav">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand d-flex align-items-center text-white fw-bold" href="#"
                style="font-family: Shrikhand; font-size: 2rem;">
                <div class="logo-container me-2">
                    <img src="../css/laundry-logo.png" alt="LaundryTracker Logo" class="logo-icon">
                </div>
                LaundryTracker
            </a>
            <div class="navbar-nav ms-auto">
                <a href="index.html" class="btn-nav1">
                    <i class="fas fa-users me-1"></i>Customer View
                </a>
                <button class="btn-nav2">
                    <i class="fas fa-cog me-1"></i>Admin Panel
                </button>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="header-image">
        <div class="text-center">
            <h1>ADMIN DASHBOARD</h1>
            <div class="divider"></div>
            <p>Manage laundry transactions and update status.</p>
        </div>

        </div>
    </header>


    <!-- Menu -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-center">
            <div class="glass-card p-3">
                <div class="btn-group w-100" role="group">
                    <button class="button btn-newtransaction active"
                        onclick="showAdminSection('newTransaction', event)">
                        <i class="fas fa-plus me-2"></i>New Transaction
                    </button>
                    <button class="button btn-manageorders" onclick="showAdminSection('manageOrders', event)">
                        <i class="fas fa-list me-2"></i>Manage Orders
                    </button>
                    <button class="button btn-generatebr" onclick="showAdminSection('generateQR', event)">
                        <i class="fas fa-barcode me-2"></i>Generate Barcode
                    </button>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Create New Laundry Transaction -->
    <div id="newTransaction" class="admin-section">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="glass-card p-4">
                    <h4 class="mb-4" style="color: #1e3a8a; font-weight: bold;">
                        <i class="fas fa-plus-circle me-2"></i>Create New Laundry Transaction
                    </h4>
                    <form id="newTransactionForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold" style="color: #1e3a8a;">Customer Name</label>
                                <input type="text" class="form-control form-control-lg" id="customerName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold" style="color: #1e3a8a;">Phone Number</label>
                                <input type="tel" class="form-control form-control-lg" id="phoneNumber" required>
                            </div>
                            <div class="col-md-12 mb-3"> <label class="form-label fw-bold"
                                    style="color: #1e3a8a;">Email</label>
                                <input type="email" class="form-control form-control-lg" id="email" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold" style="color: #1e3a8a;">Service Type</label>
                                <select class="form-select form-select-lg" id="serviceType" required>
                                    <option value="">Select Service</option>
                                    <option value="wash-only">Wash Only</option>
                                    <option value="wash-dry">Wash & Dry</option>
                                    <option value="dry-clean">Dry Clean</option>
                                    <option value="iron-only">Iron Only</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold" style="color: #1e3a8a;">Weight (kg)</label>
                                <input type="number" class="form-control form-control-lg" id="weight" step="0.1"
                                    min="0.1" max="50" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold" style="color: #1e3a8a;">Estimated Pickup Date</label>
                                <input type="date" class="form-control form-control-lg" id="pickupDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold" style="color: #1e3a8a;">Estimated Pickup Time</label>
                                <input type="time" class="form-control form-control-lg" id="pickupTime" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold" style="color: #1e3a8a;">Special Instructions</label>
                            <textarea class="form-control" id="instructions" rows="3"
                                placeholder="Any special care instructions..."></textarea>
                        </div>
                        <button type="button" class="button btn-gradient btn-lg w-100" onclick="saveTransaction()">
                            <i class="fas fa-save me-2"></i>Save Transaction
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Laundry Orders -->
    <div id="manageOrders" class="admin-section" style="display: none;">
        <div class="glass-card p-4">
            <h4 class="mb-4" style="color: #1e3a8a; font-weight: bold;">
                <i class="fas fa-list me-2"></i>Manage Laundry Orders
            </h4>
            <div class="">
                <table>
                    <thead>
                        <tr>
                            <th>Tracking Code</th>
                            <th>Customer</th>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Pickup Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="loadOrdersTable">
                        <!-- table displayy here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Barcode Generator -->
    <div id="generateQR" class="admin-section" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="glass-card p-4 text-center">
                    <h4 class="mb-4" style="color: #1e3a8a; font-weight: bold;">
                        <i class="fas fa-barcode me-2"></i>Barcode Generator
                    </h4>
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="color: #1e3a8a;">Enter Tracking Code</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="trackingInput"
                                placeholder="Enter tracking code (e.g., LT-ABC123)">
                            <button class="button button-barcode"
                                onclick="generateBarcode(document.getElementById('trackingInput').value)">
                                <i class="fas fa-barcode me-2"></i>Generate Barcode
                            </button>
                        </div>
                        <div id="barcodeDisplay" class="mt-3 text-center" style="display: none;">
                            <canvas id="barcodeCanvas"></canvas>
                            <p class="text-white mt-2">Tracking Code: <span id="trackingText"></span></p>
                            <button class="btn btn-light mt-2" onclick="printBarcode()">
                                <i class="fas fa-print me-2"></i>Print Barcode
                            </button>
                            <button class="btn btn-light mt-2 ms-2" onclick="downloadBarcode()">
                                <i class="fas fa-download me-2"></i>Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transaction Receipt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="receiptContent">
                    <div class="receipt-container">
                        <div class="receipt-header text-center">
                            <h3>Flip N Fold Laundry</h3>
                            <p>Official Receipt</p>
                            <hr>
                        </div>
                        <div class="receipt-details">
                            <p><strong>Tracking Code:</strong> <span id="receipt-tracking"></span></p>
                            <div class="text-center my-3">
                                <canvas id="receiptBarcode" width="200" height="60"></canvas>
                            </div>
                            <p><strong>Date:</strong> <span id="receipt-date"></span></p>
                            <p><strong>Customer:</strong> <span id="receipt-customer"></span></p>
                            <div class="receipt-items">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Weight</th>
                                            <th>Rate</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="receipt-items">
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                                            <td id="receipt-subtotal"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>Tax (12%):</strong></td>
                                            <td id="receipt-tax"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                            <td id="receipt-total"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="receipt-footer text-center mt-4">
                                <p>Thank you for choosing Flip N Fold!</p>
                                <p class="small">Keep this receipt for pickup reference</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printReceipt()">
                        <i class="fas fa-print me-2"></i>Print Receipt
                    </button>
                </div>
            </div>
        </div>
    </div>



    <div id="emailConfirmationFrame" style="display: none;"></div>


    <div id="loading-indicator" style="display: block;">Checking Authentication...</div>
    <div id="admin-content" style="display: none;">
        <h1>Admin Dashboard</h1>
        <button onclick="logout()">Logout</button>
    </div>


    <!-- Footer -->
    <footer>
        <p style="padding-top: 1rem;">&copy; 2025 LaundryTrack. All rights reserved.</p>
    </footer>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        let laundryData = {};

        async function loadData() {
            try {
                const querySnapshot = await getDocs(collection(db, "laundryOrders"));
                laundryData = {};
                querySnapshot.forEach((doc) => {
                    laundryData[doc.id] = { id: doc.id, ...doc.data() };
                });
                loadOrdersTable();
            } catch (error) {
                console.error("Error loading data from Firebase:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load orders data',
                    confirmButtonText: 'OK'
                });
            }
        }

        function validateForm() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            if (!/^[\d\s\+\-\(\)]{8,15}$/.test(phoneNumber)) {
                throw new Error('Please enter a valid phone number');
            }

            const weight = parseFloat(document.getElementById('weight').value);
            if (weight <= 0 || weight > 50) {
                throw new Error('Weight must be between 0.1 and 50 kg');
            }

            const pickupDate = new Date(document.getElementById('pickupDate').value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (pickupDate < today) {
                throw new Error('Pickup date must be today or in the future');
            }
        }

        function generateTrackingCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = 'LT-';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function saveTransaction() {
            try {

                const customerName = document.getElementById('customerName').value.trim();
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                const email = document.getElementById('email').value.trim();
                const serviceType = document.getElementById('serviceType').value;
                const weight = parseFloat(document.getElementById('weight').value);
                const pickupDate = document.getElementById('pickupDate').value;
                const pickupTime = document.getElementById('pickupTime').value;
                const instructions = document.getElementById('instructions').value.trim();

                if (!customerName || !phoneNumber || !serviceType || isNaN(weight) || !pickupDate || !pickupTime) {
                    throw new Error('Please fill in all required fields correctly.');
                }


                validateForm();

                const trackingCode = generateTrackingCode();


                const transaction = {
                    trackingCode,
                    customerName,
                    phoneNumber,
                    email,
                    serviceType,
                    weight,
                    pickupDate,
                    pickupTime,
                    instructions,
                    status: 'received',
                    createdAt: new Date().toISOString(),
                    timestamps: {
                        received: new Date().toLocaleString()
                    }
                };


                const docRef = await addDoc(collection(db, "laundryOrders"), transaction);
                console.log("Transaction saved with ID: ", docRef.id);


                laundryData[docRef.id] = { id: docRef.id, ...transaction };


                await Swal.fire({
                    icon: 'success',
                    title: 'Transaction Saved!',
                    html: `Tracking Code: <strong>${trackingCode}</strong>`,
                    confirmButtonText: 'OK'
                });

                showReceipt(docRef.id);


                document.getElementById('newTransactionForm').reset();


                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('pickupDate').valueAsDate = tomorrow;



                await loadData();

            } catch (error) {
                console.error("Error saving transaction:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to save transaction',
                    confirmButtonText: 'OK'
                });
            }
        }




        function showReceipt(orderId) {
            const order = laundryData[orderId];
            if (!order) return;


            const rates = {
                'wash-only': 150,
                'wash-dry': 175,
                'dry-clean': 180,
                'iron-only': 75
            };

            const rate = rates[order.serviceType] || 150;
            const amount = rate * order.weight;
            const tax = amount * 0.10;
            const total = amount + tax;


            document.getElementById('receipt-tracking').textContent = order.trackingCode;
            document.getElementById('receipt-date').textContent = new Date().toLocaleDateString();
            document.getElementById('receipt-customer').textContent = order.customerName;

            const itemsTable = document.getElementById('receipt-items');
            itemsTable.innerHTML = `
        <tr>
            <td>${getServiceTypeName(order.serviceType)}</td>
            <td>${order.weight} kg</td>
            <td>₱${rate.toFixed(2)}/kg</td>
            <td>₱${amount.toFixed(2)}</td>
        </tr>
    `;
            document.getElementById('receipt-tracking').textContent = order.trackingCode;

            // Generate barcode for receipt
            const barcodeCanvas = document.getElementById('receiptBarcode');
            JsBarcode(barcodeCanvas, order.trackingCode, {
                format: "CODE128",
                width: 2,
                height: 50,
                displayValue: false,
                margin: 0,
                background: "#fff",
                lineColor: "#000"
            });

            document.getElementById('receipt-subtotal').textContent = `₱${amount.toFixed(2)}`;
            document.getElementById('receipt-tax').textContent = `₱${tax.toFixed(2)}`;
            document.getElementById('receipt-total').textContent = `₱${total.toFixed(2)}`;

            const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
            receiptModal.show();
        }


        function printReceipt() {
            const receiptContent = document.getElementById('receiptContent').innerHTML;
            const barcodeCanvas = document.getElementById('receiptBarcode');
            const barcodeDataUrl = barcodeCanvas.toDataURL('image/png');

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Laundry Receipt</title>
            <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { padding: 20px; }
                @media print {
                    .modal-footer { display: none; }
                }
            </style>
        </head>
        <body>
            ${receiptContent}
            <div class="text-center my-3">
                <img src="${barcodeDataUrl}" alt="Barcode" style="height:50px;" />
            </div>
            <script>
                window.onload = function() {
                    window.print();
                    window.onafterprint = function() {
                        window.close();
                    }
                }
            <\/script>
        </body>
        </html>
    `);

            printWindow.document.close();
        }

        function showAdminSection(sectionId, event) {

            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });


            document.getElementById(sectionId).style.display = 'block';


            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active', 'btn-gradient');
                btn.classList.add('btn-outline-light');
            });

            if (event) {
                event.target.classList.add('active', 'btn-gradient');
                event.target.classList.remove('btn-outline-light');
            }


            if (sectionId === 'manageOrders') {
                loadOrdersTable();
            }
        }


        async function updateOrderStatusInFirebase(orderId, status) {
            try {
                const orderRef = doc(db, "laundryOrders", orderId);
                await updateDoc(orderRef, {
                    status: status,
                    timestamps: {
                        ...laundryData[orderId].timestamps,
                        [status]: new Date().toLocaleString()
                    }
                });


                laundryData[orderId].status = status;
                laundryData[orderId].timestamps[status] = new Date().toLocaleString();

                return status;
            } catch (error) {
                console.error('Error updating status:', error);
                throw new Error('Failed to update status');
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            initializeScanner();

            // Load Tesseract.js when text recognition is selected
            document.getElementById('scanType').addEventListener('change', function () {
                if (this.value === 'text' && !window.Tesseract) {
                    // Load Tesseract.js dynamically
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js';
                    document.head.appendChild(script);
                }
            });
        });

        function generateBarcode(trackingCode) {
            if (!trackingCode) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please enter a valid tracking code',
                    confirmButtonText: 'OK'
                });
                return;
            }

            try {
                const canvas = document.getElementById('barcodeCanvas');
                const container = document.getElementById('barcodeDisplay');


                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);


                JsBarcode(canvas, trackingCode, {
                    format: "CODE128",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontSize: 16,
                    margin: 10,
                    background: "#ffffff",
                    lineColor: "#000000"
                });


                document.getElementById('trackingText').textContent = trackingCode;
                container.style.display = 'block';

            } catch (error) {
                console.error('Barcode generation error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Barcode Generation Failed',
                    text: 'There was an error generating the barcode. Please try again.',
                    confirmButtonText: 'OK'
                });
            }
        }


        function printBarcode() {
            const canvas = document.getElementById('barcodeCanvas');
            const trackingCode = document.getElementById('trackingText').textContent;

            if (!canvas || !trackingCode) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No barcode to print',
                    confirmButtonText: 'OK'
                });
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Barcode - ${trackingCode}</title>
            <style>
                body { text-align: center; padding: 20px; font-family: Arial, sans-serif; }
                h3 { margin-bottom: 10px; }
                img { margin: 10px auto; display: block; }
                @media print {
                    body { padding: 0; }
                }
            </style>
        </head>
        <body>
            <h3>LaundryTrack Barcode</h3>
            <p>Tracking: ${trackingCode}</p>
            <img src="${canvas.toDataURL('image/png')}" alt="Barcode">
            <script>
                window.onload = function() {
                    setTimeout(function() {
                        window.print();
                        window.close();
                    }, 200);
                }
            <\/script>
            <p>Thank you for Trusting our service!</p>
        </body>
        </html>`);

            printWindow.document.close();
        }

        function downloadBarcode() {
            const canvas = document.getElementById('barcodeCanvas');
            const trackingCode = document.getElementById('trackingText').textContent;

            if (!canvas || !trackingCode) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No barcode to download',
                    confirmButtonText: 'OK'
                });
                return;
            }

            const link = document.createElement('a');
            link.download = `LaundryTrack-Barcode-${trackingCode}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }


        document.addEventListener('DOMContentLoaded', function () {
            // Set up canvas dimensions
            const canvas = document.getElementById('barcodeCanvas');
            canvas.width = 300;
            canvas.height = 150;


        });


        function getServiceTypeName(serviceType) {
            const serviceMap = {
                'wash-only': 'Wash Only',
                'wash-dry': 'Wash & Dry',
                'dry-clean': 'Dry Clean',
                'iron-only': 'Iron Only'
            };
            return serviceMap[serviceType] || serviceType;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }


        document.addEventListener('DOMContentLoaded', function () {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('pickupDate').valueAsDate = tomorrow;

            loadData();
        });

        document.getElementById('newTransactionForm').addEventListener('submit', function (e) {
            e.preventDefault();
            saveTransaction();
        });

        const EMAILJS_SERVICE_ID = 'service_flipnfold';
        const EMAILJS_TEMPLATE_ID = 'templete_flipnfold';





        function loadOrdersTable() {
            const tbody = document.getElementById('loadOrdersTable');
            tbody.innerHTML = '';

            const sortedOrders = Object.values(laundryData).sort((a, b) =>
                new Date(b.createdAt) - new Date(a.createdAt)
            );

            sortedOrders.forEach(order => {
                const tr = document.createElement('tr');
                const statusClass = `status-${order.status || 'received'}`;
                const statusText = (order.status || 'received').charAt(0).toUpperCase() + (order.status || 'received').slice(1);


                tr.innerHTML = `
                <td><strong>${order.trackingCode}</strong></td>
                <td>${order.customerName}<br><small class="text-muted">${order.phoneNumber}</small><br><small class="text-info">${order.email || 'No Email'}</small></td>
                <td>${getServiceTypeName(order.serviceType)}<br><small class="text-muted">${order.weight}kg</small></td>
               <td>
    <select class="form-select form-select-sm status-select" data-id="${order.id}">
         <option value="received" ${order.status === 'received' ? 'selected' : ''}>Received</option>
            <option value="washing" ${order.status === 'washing' ? 'selected' : ''}>Washing</option>
            <option value="drying" ${order.status === 'drying' ? 'selected' : ''}>Drying</option>
            <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready for Pickup</option>
            <option value="picked-up" ${order.status === 'picked-up' ? 'selected' : ''}>Picked Up</option>
    </select>
</td>
                <td>${formatDate(order.pickupDate)}<br><small class="text-muted">${order.pickupTime}</small></td>
              
                <td>
                    ${order.status !== 'completed' ?
                        `<button class="btn btn-sm btn-success mark-done me-1" data-id="${order.id}">
                            <i class="fas fa-check"></i> Complete
                        </button>` :
                        '<span class="text-success"><i class="fas fa-check-circle"></i> Done</span>'
                    }
                    <button class="btn btn-sm btn-danger delete-order" data-id="${order.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
                tbody.appendChild(tr);
            });


            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', async function () {
                    const orderId = this.getAttribute('data-id');
                    const newStatus = this.value;
                    const order = laundryData[orderId];
                    try {
                        const orderRef = doc(db, "laundryOrders", orderId);
                        await updateDoc(orderRef, {
                            status: newStatus,
                            timestamps: {
                                ...order.timestamps,
                                [newStatus]: new Date().toLocaleString()
                            }
                        });
                        laundryData[orderId].status = newStatus;
                        laundryData[orderId].timestamps[newStatus] = new Date().toLocaleString();
                        loadOrdersTable();
                        Swal.fire({
                            icon: 'success',
                            title: 'Status Updated',
                            text: `Order ${order.trackingCode} status updated to ${newStatus}`,
                            confirmButtonText: 'OK',
                            timer: 2000
                        });
                    } catch (error) {
                        console.error("Error updating status:", error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to update order status',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });
            document.querySelectorAll('.mark-done').forEach(button => {
                button.addEventListener('click', async function () {
                    const orderId = this.getAttribute('data-id');
                    const order = laundryData[orderId];

                    try {
                        const orderRef = doc(db, "laundryOrders", orderId);
                        await updateDoc(orderRef, {
                            status: 'completed',
                            timestamps: {
                                ...order.timestamps,
                                completed: new Date().toLocaleString()
                            }
                        });

                        laundryData[orderId].status = 'completed';
                        laundryData[orderId].timestamps.completed = new Date().toLocaleString();

                        loadOrdersTable();

                        Swal.fire({
                            icon: 'success',
                            title: 'Order Completed',
                            text: `Order ${order.trackingCode} has been marked as completed`,
                            confirmButtonText: 'OK',
                            timer: 2000
                        });
                    } catch (error) {
                        console.error("Error updating order:", error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to update order status',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });

            document.querySelectorAll('.delete-order').forEach(button => {
                button.addEventListener('click', async function () {
                    const orderId = this.getAttribute('data-id');

                    const result = await Swal.fire({
                        title: 'Are you sure?',
                        text: "You won't be able to revert this!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, delete it!'
                    });

                    if (result.isConfirmed) {
                        try {
                            await deleteDoc(doc(db, "laundryOrders", orderId));
                            delete laundryData[orderId];
                            loadOrdersTable();
                            Swal.fire(
                                'Deleted!',
                                'The order has been deleted.',
                                'success'
                            );
                        } catch (error) {
                            console.error("Error deleting order:", error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to delete order',
                                confirmButtonText: 'OK'
                            });
                        }
                    }
                });
            });


        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();

            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('pickupDate').valueAsDate = tomorrow;

            document.getElementById('messageType').addEventListener('change', function () {
                if (this.value === 'custom') {
                    document.getElementById('customMessageDiv').style.display = 'block';
                } else {
                    document.getElementById('customMessageDiv').style.display = 'none';
                }
            });

            document.querySelector('#notificationModal .btn-gradient').addEventListener('click', sendNotification);
        });
    </script>


    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <script>
        const { Client, Account } = Appwrite;

        const client = new Client()
            .setEndpoint('https://fra.cloud.appwrite.io/v1')
            .setProject('683bd6c5003a65d4deaa');

        const account = new Account(client);

        const loadingIndicator = document.getElementById('loading-indicator');
        const adminContent = document.getElementById('admin-content');

        (async () => {
            try {
                await account.get();
                loadingIndicator.style.display = 'none';
                adminContent.style.display = 'block';
            } catch {
                window.location.href = 'login.html';
            }
        })();

        function logout() {
            account.deleteSession('current').then(() => {
                window.location.href = 'login.html';
            });
        }
    </script>


</body>

</html>